#!/usr/bin/env ruby

require "uri"
require "open-uri"
require "nokogiri"

def parse_time(time)
  m = 0
  t = time.dup
  t.sub!(/Total time:/, "")
  m += $1.to_i * 60 if t.sub!(/(\d+)hr/, "")
  m += $1.to_i if t.sub!(/(\d+)mins?/, "")
  t.gsub!(/\s|\u{A0}/, "")
  raise "Time parse error: #{time.inspect}" unless t.empty?
  m
end

def tfl_uri(from, to)
  "https://tfl.gov.uk/plan-a-journey/results?" + %W[
  From=#{URI.escape(from)}
  To=#{URI.escape(to)}
  JpType=publictransport
  Mode=bus
  Mode=tube
  Mode=national-rail
  Mode=dlr
  Mode=overground
  Mode=tflrail
  Mode=river-bus
  Mode=tram
  Mode=cable-car
  Mode=coach
  ].join("&")
end

def doc(url)
  Nokogiri(open(url).read)
end

def travel_time(from, to)
  uri = tfl_uri(from, to)
  doc = Nokogiri(open(uri).read)
  doc.css(".publictransport-box .journey-time").map(&:text).map{|t| parse_time(t)}.min
end

from, to = ARGV
t = travel_time(from, to)
if t
  puts t
else
  # system "open", tfl_uri(from, to)
  warn "Can't find travel time from `#{from}' to `#{to}'"
end
